{% extends 'lancamentos/base.html' %}

{% block title %}{% if lancamento %}Editar Lançamento{% else %}Novo Lançamento{% endif %}{% endblock %}

{% block content %}
    <h1>{% if lancamento %}Editar Lançamento{% else %}Adicionar Novo Lançamento{% endif %}</h1>

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-danger" role="alert">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}

    <form method="POST">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ next_page|default:'fatura_cartao' }}"> 

        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="local" class="form-label">Local da Compra:</label>
                    <input type="text" id="local" name="local" value="{% if lancamento %}{{ lancamento.local_compra }}{% else %}{{ form_data.local|default:'' }}{% endif %}" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label for="descricao" class="form-label">Descrição (Opcional):</label>
                    <textarea id="descricao" name="descricao" rows="3" class="form-control">{% if lancamento %}{{ lancamento.descricao|default:'' }}{% else %}{{ form_data.descricao|default:'' }}{% endif %}</textarea>
                </div>
                
                <div class="mb-3">
                    <label for="data" class="form-label">Data da Compra:</label>
                    <input type="date" id="data" name="data" value="{% if lancamento %}{{ lancamento.data_compra|date:'Y-m-d' }}{% else %}{{ form_data.data|default:'' }}{% endif %}" class="form-control" required>
                </div>

                <div class="mb-3">
                    <label for="valor" class="form-label">Valor Total:</label>
                    <input type="number" step="0.01" id="valor" name="valor" value="{% if lancamento %}{{ lancamento.valor_total }}{% else %}{{ form_data.valor|default:'' }}{% endif %}" class="form-control" required>
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="metodo_pagamento" class="form-label">Método de Pagamento:</label>
                    <select id="metodo_pagamento" name="metodo_pagamento" class="form-select" required>
                        <option value="" disabled {% if not lancamento and not form_data.metodo_pagamento %}selected{% endif %}>--- Selecione ---</option>
                        <option value="Crédito" {% if lancamento.metodo_pagamento == 'Crédito' or form_data.metodo_pagamento == 'Crédito' %}selected{% endif %}>Crédito</option>
                        <option value="Débito" {% if lancamento.metodo_pagamento == 'Débito' or form_data.metodo_pagamento == 'Débito' %}selected{% endif %}>Débito</option>
                        <option value="PIX" {% if lancamento.metodo_pagamento == 'PIX' or form_data.metodo_pagamento == 'PIX' %}selected{% endif %}>PIX</option>
                        <option value="Dinheiro" {% if lancamento.metodo_pagamento == 'Dinheiro' or form_data.metodo_pagamento == 'Dinheiro' %}selected{% endif %}>Dinheiro</option>
                    </select>
                </div>

                <div class="mb-3" id="campo-cartao" style="display: none;"> 
                    <label for="cartao_id" class="form-label">Cartão de Crédito:</label>
                    <select id="cartao_id" name="cartao_id" class="form-select">
                        <option value="">--- Selecione um cartão ---</option>
                        {% for cartao in cartoes %}
                            <option value="{{ cartao.id }}" {% if lancamento.cartao_id == cartao.id or form_data.cartao_id|add:0 == cartao.id %}selected{% endif %}>
                                {{ cartao.nome }} (Limite: R$ {{ cartao.limite }})
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div class="mb-3" id="campo-parcelas" style="display: none;"> 
                    <label for="parcelas" class="form-label">Nº de Parcelas:</label>
                    <input type="number" id="parcelas" name="parcelas" value="{% if lancamento %}{{ lancamento.num_parcelas }}{% else %}{{ form_data.parcelas|default:1 }}{% endif %}" class="form-control" min="1" required>
                </div>

                <div class="mb-3">
                    <label for="categoria" class="form-label">Categoria:</label>
                    <select id="categoria" name="categoria" class="form-select" required>
                        <option value="">--- Selecione uma categoria ---</option>
                        {% for categoria in categorias %}
                        <option value="{{ categoria.id }}" {% if lancamento.categoria_id == categoria.id or form_data.categoria|add:0 == categoria.id %}selected{% endif %}>
                            {{ categoria.nome }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
            </div>
        </div>

        <button type="submit" class="btn btn-primary mt-3">Salvar Lançamento</button>
        <a href="{{ next_page|default:'/' }}" class="btn btn-secondary mt-3">Voltar</a>
    </form>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const metodoPagamentoSelect = document.getElementById('metodo_pagamento');
            const campoParcelas = document.getElementById('campo-parcelas');
            const inputParcelas = document.getElementById('parcelas');
            const campoCartao = document.getElementById('campo-cartao');
            const selectCartao = document.getElementById('cartao_id');

            function toggleCamposCredito() {
                if (metodoPagamentoSelect.value === 'Crédito') {
                    campoParcelas.style.display = 'block';
                    campoCartao.style.display = 'block';
                    inputParcelas.required = true;
                    selectCartao.required = true; 
                    if (inputParcelas.value < 1 || inputParcelas.value === '') {
                        inputParcelas.value = 1;
                    }
                } else {
                    campoParcelas.style.display = 'none';
                    campoCartao.style.display = 'none';
                    inputParcelas.required = false;
                    selectCartao.required = false;
                    inputParcelas.value = 1; 
                }
            }
            
            toggleCamposCredito();
            metodoPagamentoSelect.addEventListener('change', toggleCamposCredito);
        });
    </script>
{% endblock %}